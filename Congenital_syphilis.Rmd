---
title: "Congenital syphilis tables and graphics"
author: "CardenasA"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(sf)
library(purrr)
library(tidyverse)
library(ggplot2)
library(ggrepel)
library(readr)
library(survey)
library(ggspatial)
library(kableExtra)
library(gt)
```

# Cargando las datas

```{r, echo=FALSE}
data_ubigeo <- read_csv("Data_final/data_ubigeo_innovalab.csv")
data_ubigeo_2022_innova <- read_csv("Data_final/data_ubigeo_2022_innova.csv")
provincias <- read_sf("Límites - mapas/PROVINCIAS_inei_geogpsperu_suyopomalia.shp")
departamentos <- read_sf("Límites - mapas/DEPARTAMENTOS_inei_geogpsperu_suyopomalia.shp")
data_syphilis <- read_csv("Data_final/data_syphilis.csv")
congenital <- read_csv("Data_final/syphilis_congenital.csv")
newborn <- read_csv("Data_final/Nacidos_vivos_long.csv")
```

Limpieza de la data

```{r, echo=FALSE}
data_ubigeo_2022_innova = data_ubigeo_2022_innova[,c(2:6,1,7:9)]
data_ubigeo = data_ubigeo[,c(1:6,8,10,12)]

data_ubigeo_2022_innova = rename(data_ubigeo_2022_innova, c("NOMBDEP"="DEPARTAMEN","NOMBPROV"="PROVINCIA","NOMBDIST"="DISTRITO"))

data_ubigeo = rbind(data_ubigeo,data_ubigeo_2022_innova)

data_total <- data_syphilis%>% 
  left_join(data_ubigeo, by = c("caseid","year"))

data_total <- data_total %>%
  left_join(provincias, by = c("NOMBDEP", "NOMBPROV"))
```

```{r, echo=FALSE}
congenital <- congenital %>%
 select(c(2:13))
  #select(!c(4:7))

congenital <- rename(
  congenital, c("NOMBDEP"="DEPARTAMENTO","NOMBPROV"="PROVINCIA","NOMBDIST"="DISTRITO"))

congenital_long <- pivot_longer(congenital, cols = c(4:12), 
                                names_to = "year", values_to = "congenital")

congenital_long <- congenital_long %>%
  group_by(NOMBDEP, NOMBPROV, year) %>%
  summarise(congenital = sum(congenital, na.rm = TRUE)) %>%
  unnest(congenital)

newborn <- newborn %>%
 rename(c("NOMBDEP"="departamento","NOMBPROV"="provincia", "year"="years")) %>%
 mutate(year = as.character(year)) 

```

```{r}
data_congenital <- congenital_long %>%
  left_join(newborn, by = c("NOMBDEP","NOMBPROV","year")) %>%
  mutate(rate = (congenital/n)*1000) %>% 
  mutate_if(is.numeric, round, 2) %>%
  left_join(provincias, by = c("NOMBDEP","NOMBPROV"))
```
## Casos de sífilis congénita por 1000 nacidos vivos por departamento.

#Dumbell Plot años 2014, 2018 y 2022.


```{r pressure, echo=FALSE}

d14_d22 <- data_congenital %>%
  group_by(NOMBDEP, year) %>%
  summarise(rate = mean(rate, na.rm = TRUE)) %>%
  mutate_if(is.numeric, round, 2) %>%
  unnest(rate) %>%
  filter(year==2015|year==2018|year==2022) 

d14_d22_congenital <- ggplot(d14_d22, aes(x = rate, y = NOMBDEP)) +
  geom_line() +
  geom_point(aes(color = year), size = 3) +
  xlab("Rate of congenital syphilis per 1000 newborns")+
  ylab("Departments")

ggsave("Graph_dumbell_3b.png", plot = d14_d22_congenital, width = 8, height = 4, dpi = 300)
```

# Tabla de las 10 provincias con más casos de sífilis congénita por 1000 nacidos vivos.

```{r, echo=FALSE}

data_congenital_table <- data_congenital %>%
  select(NOMBDEP, NOMBPROV, year, rate) %>%
  arrange(desc(rate)) %>%
  head(n= 10) %>%
  gt(groupname_col = FALSE) %>%
  tab_header(
    title = "Departments, provinces and years with the highest rate of congenital sifilis"
  ) %>%
  tab_footnote(
    footnote = "Rate per 1000 newborn",
    locations = cells_column_labels(columns = rate)
  )
data_congenital_table

```
Tabla de departamentos y provincias que en el 2022 tuvieron ≤ 0.5 por 1000 nacidos vivos con sífilis congénita

```{r, echo=FALSE}
data_congenital_goal <- data_congenital %>%
  group_by(NOMBDEP, year) %>%
  summarise(meanrate = mean(rate)) %>%
  mutate_if(is.numeric, round, 2) %>%
  filter (year =="2022", meanrate < 0.5) 

data_congenital_goal <- as.data.frame(data_congenital_goal)

data_congenital_goal2 <- data_congenital %>%
  group_by(NOMBDEP, NOMBPROV, year) %>%
  summarise(meanrate = mean(rate)) %>%
  mutate_if(is.numeric, round, 2) %>%
  filter (year =="2022", meanrate < 0.5) %>%
  group_by(NOMBDEP) %>%
  count(NOMBDEP) 

data_congenital_goal2 <- as.data.frame(data_congenital_goal2)

data_congenital_goal <- data_congenital_goal %>%
  left_join(data_congenital_goal2) %>%
  rename("nprovincias" = "n") %>%
  gt(groupname_col = FALSE) %>%
  tab_header(
    title = "Departments with less than 0.5 cases of congenital syphilis per 1000 newborn in 2022"
  ) %>%
  tab_footnote(
    footnote = "Number of provinces which reached the goal",
    locations = cells_column_labels(columns = nprovincias)
  )
data_congenital_goal
  

```

# Mapa de casos de sífilis congénita por 1000 nacidos vivos por departamento.

```{r, echo=FALSE}
data_congenital <- data_congenital %>%
  group_by(NOMBDEP, year) %>%
  summarise(rate = mean(rate, na.rm = TRUE)) %>%
  left_join(departamentos, by = c("NOMBDEP"))
```

Mapa que incluye el promedio de casos desde 2014 al 2022

```{r}
ggplot() +
  geom_sf(data = data_congenital,
          aes(geometry = geometry,fill = rate),
          color = "black", size = 0.2) +
  scale_fill_gradient(low = "skyblue", high = "blue") +
  labs(title="Cases of congenital syphilis per 1000 newborn",
       fill = "Rate") 

```

Mapa de casos por años

```{r}
ggplot() +
  geom_sf(data = data_congenital,
          aes(geometry = geometry,fill = rate),
          color = "black", size = 0.2) +
  scale_fill_gradient(low = "skyblue", high = "blue") +
  facet_wrap(.~year) + 
  labs(title="Cases of congenital syphilis per 1000 newborn",
       fill = "Rate")
```
