---
title: "Determinantes 4"
output: html_document
date: "2024-05-30"
---
```{r}
library(sf)
library(purrr)
library(tidyverse)
library(ggplot2)
library(ggrepel)
library(readr)
library(survey)
library(gridExtra)
library(cowplot)
library(readxl)
```

```{r}
knitr::opts_chunk$set(
	echo = FALSE,
	cache = FALSE,
	dev = "png",
	dpi = 300
)
```

```{r}
data_enaho <- read_csv("Data_enaho/enaho2.csv")

data_ubigeo <- read_csv("Data_final/data_ubigeo_innovalab.csv")

departamentos <- read_sf("LÃ­mites - mapas/DEPARTAMENTOS_inei_geogpsperu_suyopomalia.shp")
#data_syphilis <- read_csv("Data_final/data_syphilis.csv")

data_enaho = rename(data_enaho, c("UBIGEO"="ubigeo"))

data_ubigeo = data_ubigeo %>%
  filter(year > 2014)

data_ubigeo = data_ubigeo [,c(8,10,12,14)]

data_ubigeo = distinct(data_ubigeo)

data_enaho <- data_enaho %>%
  left_join(data_ubigeo, by = c("UBIGEO")) %>%
  mutate(
    year = as.numeric(data_enaho$year)
  )

rm(data_syphilis,data_ubigeo)
```

Uploading MINSA data (maternal and congenital syphilis):

```{r, echo=FALSE}
maternal <- read_csv("Data_final/syphilis_maternal.csv")
newborn <- read_csv("Data_final/Nacidos_vivos_long.csv")
newborn_distrito <- read_excel("Data_final/Reniec_Nacimientos_Distritos.xlsx")

newborn_distrito = newborn_distrito %>% 
  mutate(across(c(NOMBDEP, NOMBPROV, NOMBDIST),
                ~ toupper(.x) %>%
                  stringi::stri_trans_general("Latin-ASCII")))

maternal = rename(
  maternal, c("NOMBDEP"="departamento","NOMBPROV"="provincia","NOMBDIST"="distrito"))
newborn = rename(
  newborn, c("NOMBDEP"="departamento","NOMBPROV"="provincia","year"="years"))

maternal_long <- pivot_longer(maternal, cols = c(4:11), 
                                names_to = "year", values_to = "maternal")

congenital <- read_csv("Data_final/syphilis_congenital.csv")

congenital <- congenital %>%
  select(!c(1))

congenital <- rename(
  congenital, c("NOMBDEP"="DEPARTAMENTO","NOMBPROV"="PROVINCIA","NOMBDIST"="DISTRITO"))

congenital_long <- pivot_longer(congenital, cols = c(4:12), 
                                names_to = "year", values_to = "congenital")

#Provincial
#newborn_prov <- newborn %>%
  #group_by(NOMBDEP, NOMBPROV, year) %>%
  #summarise(newborntotal =sum(n, na.rm = TRUE)) %>%
  #ungroup()

#Regional
#newborn_dep <- newborn %>%
  #group_by(NOMBDEP, year) %>%
  #summarise(newborntotal =sum(n, na.rm = TRUE)) %>%
  #ungroup()

#National
#newborn_nac <- newborn %>%
  #group_by(year) %>%
  #summarise(newborntotal =sum(n, na.rm = TRUE)) %>%
  #ungroup()

rm(maternal,congenital,newborn)
```

Maternal 

```{r}
data_maternal_dist <- maternal_long %>%
  group_by(NOMBDEP, NOMBPROV, NOMBDIST, year) %>%
  filter( year > 2014) %>%
  summarise(maternal =sum(maternal, na.rm = TRUE)) %>%
  mutate(year=as.numeric(year))%>%
  ungroup()

#data_maternal_prov <- maternal_long %>%
  #group_by(NOMBDEP, NOMBPROV, year) %>%
  #filter( year > 2014) %>%
  #summarise(maternal =sum(maternal, na.rm = TRUE)) %>%
  #mutate(year=as.numeric(year))%>%
  #ungroup()

#data_maternal_dep <- maternal_long %>%
  #group_by(NOMBDEP, year) %>%
  #filter( year > 2014) %>%
  #summarise(maternal =sum(maternal, na.rm = TRUE)) %>%
  #mutate(year=as.numeric(year))%>%
  #ungroup()

#data_maternal_nac<- maternal_long %>%
  #group_by(year) %>%
  #filter( year > 2014) %>%
  #summarise(maternal =sum(maternal, na.rm = TRUE)) %>%
  #mutate(year=as.numeric(year))%>%
  #ungroup()

#Calculating rates of maternal syphilis 
data_maternal_dist <- data_maternal_dist %>%
  left_join(newborn_distrito, by = c("NOMBDEP","NOMBPROV","NOMBDIST","year")) %>%
  mutate(rate_mat = (maternal/newborntotal)*1000)

#data_maternal_prov <- data_maternal_prov %>%
  #left_join(newborn_prov, by = c("NOMBDEP","NOMBPROV","year")) %>%
  #mutate(rate_mat = (maternal/newborntotal)*1000)

#data_maternal_dep <- data_maternal_dep %>%
  #left_join(newborn_dep, by = c("NOMBDEP","year")) %>%
  #mutate(rate_mat = (maternal/newborntotal)*1000) %>% 
  #mutate_if(is.numeric, round, 2)

#data_maternal_nac <- data_maternal_nac %>%
  #left_join(newborn_nac, by = c("year")) %>%
  #mutate(rate_mat = (maternal/newborntotal)*1000) %>% 
  #mutate_if(is.numeric, round, 2)
```

Congenital:

```{r}
congenital_long$year = as.numeric(congenital_long$year) 

#Distrital
congenital_long_dist <- congenital_long %>%
  group_by(NOMBDEP,NOMBPROV,NOMBDIST, year) %>%
  filter (year >2014) %>%
  summarise(congenital = sum(congenital, na.rm = TRUE)) %>%
  unnest(congenital)

data_congenital_dist <- congenital_long_dist %>%
  left_join(newborn_distrito, by = c("NOMBDEP","NOMBPROV","NOMBDIST","year")) %>%
  mutate(rate_con = (congenital/newborntotal)*1000) %>% 
  mutate_if(is.numeric, round, 2) 

#Provincial
#congenital_long_prov <- congenital_long %>%
  #group_by(NOMBDEP,NOMBPROV, year) %>%
  #summarise(congenital = sum(congenital, na.rm = TRUE)) %>%
  #unnest(congenital)

#data_congenital_prov <- congenital_long_prov %>%
  #left_join(newborn_prov, by = c("NOMBDEP","NOMBPROV","year")) %>%
  #mutate(rate_con = (congenital/newborntotal)*1000) %>% 
  #mutate_if(is.numeric, round, 2) %>%
  #filter(rate_con < 100.0)

#Regional
#congenital_long_dep <- congenital_long %>%
  #group_by(NOMBDEP,year) %>%
  #summarise(congenital = sum(congenital, na.rm = TRUE)) %>%
  #unnest(congenital)

#data_congenital_dep <- congenital_long_dep %>%
  #left_join(newborn_dep, by = c("NOMBDEP","year")) %>%
  #mutate(rate_con = (congenital/newborntotal)*1000) %>% 
  #mutate_if(is.numeric, round, 2) %>%
  #filter(rate_con < 100.0)

#National
#congenital_long_nac <- congenital_long %>%
  #group_by(year) %>%
  #summarise(congenital = sum(congenital, na.rm = TRUE)) %>%
  #unnest(congenital)

#data_congenital_nac <- congenital_long_nac %>%
  #left_join(newborn_nac, by = c("year")) %>%
  #mutate(rate_con = (congenital/newborntotal)*1000) %>% 
  #mutate_if(is.numeric, round, 2)

rm(congenital_long,congenital_long_dep,congenital_long_nac,newborn_nac,newborn_dep,data_ins_long,newborn_nac,newborn_dep)
```

## Poverty

```{r}
library(RSQLite)
poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

Poverty objective 2
```{r}
poverty_mr = 
  poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

poverty_mr = poverty_mr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <7.05 ~ "First quartile",
                            poverty >=7.05 & poverty <15.37 ~ "Second quantile",
                            poverty >=15.37 & poverty <=26.28 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

poverty_mr %>% 
     DT::datatable()
``` 

```{r}
poverty_mrg =
  ggplot(data = poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

poverty_mrg <- poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10), 
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1))

#ggsave("dep_wealth_obj2.png", plot = poverty_mrg, width = 8, height = 4, dpi = 300)
```

Poverty objective 3

```{r}
poverty_cr = 
  poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

poverty_cr = poverty_cr %>%  
mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <6.64 ~ "First quartile",
                            poverty >=6.64 & poverty <13.19 ~ "Second quantile",
                            poverty >=13.19 & poverty <=24.28 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

poverty_cr %>% 
     DT::datatable()
```

```{r}
poverty_crg =
  ggplot(data = poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

poverty_crg <- poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 

#ggsave("prov_wealth_obj3.png", plot = poverty_crg, width = 8, height = 4, dpi = 300)
```

```{r}
library(patchwork)
combined_plot <- poverty_mrg + poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

National  <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at the National Level", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )
National
```

## Poverty base AMAZONAS
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "AMAZONAS") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 AMAZONAS
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <19.19 ~ "First quantile",
                            poverty >=19.19 & poverty <28.36 ~ "Second quantile",
                            poverty >=28.36 & poverty <=43.95 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 AMAZONAS
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <16.03 ~ "First quantile",
                            poverty >=16.03 & poverty <22.78 ~ "Second quantile",
                            poverty >=22.78 & poverty <=45.18 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Amazonas <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Amazonas", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Amazonas
```

## Poverty base ANCASH
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "ANCASH") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 ANCASH
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <6.23 ~ "First quantile",
                            poverty >=6.23 & poverty <11.30 ~ "Second quantile",
                            poverty >=11.30 & poverty <=19.76 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 ANCASH
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <7.59 ~ "First quantile",
                            poverty >=7.59 & poverty <9.80 ~ "Second quantile",
                            poverty >=9.80 & poverty <=16.16 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Ancash <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Ancash", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Ancash
```

## Poverty base AREQUIPA
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "AREQUIPA") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 AREQUIPA
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <2.80 ~ "First quantile",
                            poverty >=2.80 & poverty <6.29 ~ "Second quantile",
                            poverty >=6.29 & poverty <=10.31 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 AREQUIPA
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <3.49 ~ "First quantile",
                            poverty >=3.49 & poverty <6.35 ~ "Second quantile",
                            poverty >=6.35 & poverty <=11.95 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Arequipa <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Arequipa", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Arequipa
```

## Poverty base AYACUCHO
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "AYACUCHO") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 AYACUCHO
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <16.67 ~ "First quantile",
                            poverty >=16.67 & poverty <29.83 ~ "Second quantile",
                            poverty >=29.83 & poverty <=41.85 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 AYACUCHO
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <16.56 ~ "First quantile",
                            poverty >=16.56 & poverty <25.77 ~ "Second quantile",
                            poverty >=25.77 & poverty <=32.46 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Ayacucho <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Ayacucho", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Ayacucho
```

## Poverty base CAJAMARCA
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "CAJAMARCA") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 CAJAMARCA
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <21.78 ~ "First quantile",
                            poverty >=21.78 & poverty <28.37 ~ "Second quantile",
                            poverty >=28.37 & poverty <=40.60 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 CAJAMARCA
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <25.17 ~ "First quantile",
                            poverty >=25.17 & poverty <29.10 ~ "Second quantile",
                            poverty >=29.10 & poverty <=40.43~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Cajamarca <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Cajamarca", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Cajamarca
```

## Poverty base CALLAO
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "CALLAO") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 CALLAO
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <6.77 ~ "First quantile",
                            poverty >=6.77 & poverty <13.19 ~ "Second quantile",
                            poverty >=13.19 & poverty <=19.20 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 CALLAO
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <6.46 ~ "First quantile",
                            poverty >=6.46 & poverty <13.11 ~ "Second quantile",
                            poverty >=13.11 & poverty <=19.20 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Callao <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Callao", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Callao
```

## Poverty base CUSCO
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "CUSCO") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 CUSCO
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_mr$povertypoor)*100,2)

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <0.43 ~ "First quantile",
                            poverty >=0.43 & poverty <12.50 ~ "Second quantile",
                            poverty >=12.50 & poverty <=25.44 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 CUSCO
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_cr$povertypoor)*100,2)

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <0.00 ~ "First quantile",
                            poverty >=0.00 & poverty <7.72 ~ "Second quantile",
                            poverty >=7.72 & poverty <=18.33 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Cusco <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Cusco", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Cusco
```

## Poverty base HUANCAVELICA
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "HUANCAVELICA") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 HUANCAVELICA
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <24.92 ~ "First quantile",
                            poverty >=24.92 & poverty <33.37 ~ "Second quantile",
                            poverty >=33.37 & poverty <=42.00 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 HUANCAVELICA
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <25.10 ~ "First quantile",
                            poverty >=25.10 & poverty <29.21 ~ "Second quantile",
                            poverty >=29.21 & poverty <=32.68 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Huancavelica <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Huancavelica", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Huancavelica
```

## Poverty base HUANUCO
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "HUANUCO") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 HUANUCO
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <13.38 ~ "First quantile",
                            poverty >=13.38 & poverty <25.00 ~ "Second quantile",
                            poverty >=25.00 & poverty <=39.11 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 HUANUCO
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <13.97 ~ "First quantile",
                            poverty >=13.97 & poverty <23.27 ~ "Second quantile",
                            poverty >=23.27 & poverty <=37.33 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Huanuco <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Huanuco", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Huanuco
```

## Poverty base ICA
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "ICA") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 ICA
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <13.38 ~ "First quantile",
                            poverty >=13.38 & poverty <25.00 ~ "Second quantile",
                            poverty >=25.00 & poverty <=39.11 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 ICA
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <0.52 ~ "First quantile",
                            poverty >=0.52 & poverty <2.43 ~ "Second quantile",
                            poverty >=2.43 & poverty <=4.84 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Ica <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Ica", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Ica
```

## Poverty base JUNIN
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "JUNIN") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 JUNIN
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <8.26 ~ "First quantile",
                            poverty >=8.26 & poverty <16.67 ~ "Second quantile",
                            poverty >=16.67 & poverty <=27.93 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 JUNIN
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <8.80 ~ "First quantile",
                            poverty >=8.80 & poverty <14.51 ~ "Second quantile",
                            poverty >=14.51 & poverty <=25.33 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Junin <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Junin", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Junin
```

## Poverty base LA LIBERTAD
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "LA LIBERTAD") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 LA LIBERTAD
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <7.82 ~ "First quantile",
                            poverty >=7.82 & poverty <16.47 ~ "Second quantile",
                            poverty >=16.47 & poverty <=25.75 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 LA LIBERTAD
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <10.85 ~ "First quantile",
                            poverty >=10.85 & poverty <17.81 ~ "Second quantile",
                            poverty >=17.81 & poverty <24.21 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Libertad <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at La Libertad", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Libertad
```

## Poverty base LAMBAYEQUE
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "LAMBAYEQUE") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 LAMBAYEQUE
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <4.83 ~ "First quantile",
                            poverty >=4.83 & poverty <7.86 ~ "Second quantile",
                            poverty >=7.86 & poverty <=12.55 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 LAMBAYEQUE
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <6.05 ~ "First quantile",
                            poverty >=6.05 & poverty <9.58 ~ "Second quantile",
                            poverty >=9.58 & poverty <=12.41 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Lambayeque <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Lambayeque", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Lambayeque
```

## Poverty base LIMA
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "LIMA") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 LIMA
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_mr$povertypoor)*100,2)

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <5.39 ~ "First quantile",
                            poverty >=5.39 & poverty <10.97 ~ "Second quantile",
                            poverty >=10.97 & poverty <=16.50 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

#intentar como punto de corte la mediana 

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 LIMA
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_cr$povertypoor)*100,2)

dep_poverty_cr = dep_poverty_cr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <6.35 ~ "First quantile",
                            poverty >=6.35 & poverty <11.37 ~ "Second quantile",
                            poverty >=11.37 & poverty <=16.88 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Lima <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Lima", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Lima
```

## Poverty base LORETO
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "LORETO") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 LORETO
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_mr$povertypoor)*100,2)

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <17.09 ~ "First quantile",
                            poverty >=17.09 & poverty <24.78 ~ "Second quantile",
                            poverty >=24.78 & poverty <=40.34 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 LORETO
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_cr$povertypoor)*100,2)

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <12.07 ~ "First quantile",
                            poverty >=12.07 & poverty <21.43 ~ "Second quantile",
                            poverty >=21.43 & poverty <=31.26 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Loreto <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Loreto", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Loreto
```

## Poverty base MADRE DE DIOS
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "MADRE DE DIOS") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 MADRE DE DIOS
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_mr$povertypoor)*100,2)

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <0.59 ~ "First quantile",
                            poverty >=0.59 & poverty <4.08 ~ "Second quantile",
                            poverty >=4.08 & poverty <=8.69 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 MADRE DE DIOS
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_cr$povertypoor)*100,2)

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <1.65 ~ "First quantile",
                            poverty >=1.65 & poverty <3.88 ~ "Second quantile",
                            poverty >=3.88 & poverty <=8.37 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

MDD <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Madre de Dios", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

MDD
```

## Poverty base MOQUEGUA
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "MOQUEGUA") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 MOQUEGUA
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_mr$povertypoor)*100,2)

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <3.23 ~ "First quantile",
                            poverty >=3.23 & poverty <5.25 ~ "Second quantile",
                            poverty >=5.25 & poverty <=7.44 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 MOQUEGUA
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_cr$povertypoor)*100,2)

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <3.46 ~ "First quantile",
                            poverty >=3.46 & poverty <4.41 ~ "Second quantile",
                            poverty >=4.41 & poverty <=6.31 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Moquegua <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Moquegua", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Moquegua
```

## Poverty base PASCO
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "PASCO") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 PASCO
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_mr$povertypoor)*100,2)

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <14.29 ~ "First quantile",
                            poverty >=14.29 & poverty <26.79 ~ "Second quantile",
                            poverty >=26.79 & poverty <=36.15 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 PASCO
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_cr$povertypoor)*100,2)

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <21.18 ~ "First quantile",
                            poverty >=21.18 & poverty <29.10 ~ "Second quantile",
                            poverty >=29.10 & poverty <=39.20 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Pasco <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Pasco", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Pasco
```

## Poverty base PIURA
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "PIURA") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 PIURA
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_mr$povertypoor)*100,2)

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <14.18 ~ "First quantile",
                            poverty >=14.18 & poverty <21.10 ~ "Second quantile",
                            poverty >=21.10 & poverty <=28.94 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 PIURA
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_cr$povertypoor)*100,2)

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <10.08 ~ "First quantile",
                            poverty >=10.08 & poverty <17.67 ~ "Second quantile",
                            poverty >=17.67 & poverty <=21.93 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Piura <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Piura", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Piura
```

## Poverty base PUNO
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "PUNO") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 PUNO
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_mr$povertypoor)*100,2)

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <24.47 ~ "First quantile",
                            poverty >=24.47 & poverty <29.90 ~ "Second quantile",
                            poverty >=29.90 & poverty <=45.90 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 PUNO
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_cr$povertypoor)*100,2)

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <14.65 ~ "First quantile",
                            poverty >=14.65 & poverty <21.06 ~ "Second quantile",
                            poverty >=21.06 & poverty <=26.21 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Puno <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Puno", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Puno
```

## Poverty base SAN MARTIN
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "SAN MARTIN") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 SAN MARTIN
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_mr$povertypoor)*100,2)

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <10.32 ~ "First quantile",
                            poverty >=10.32 & poverty <16.34 ~ "Second quantile",
                            poverty >=16.34 & poverty <=25.00 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 SAN MARTIN
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_cr$povertypoor)*100,2)

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <12.35 ~ "First quantile",
                            poverty >=12.35 & poverty <16.67 ~ "Second quantile",
                            poverty >=16.67 & poverty <=21.22 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

SM <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at San Martin", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

SM
```

## Poverty base TACNA
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "TACNA") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 TACNA
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_mr$povertypoor)*100,2)

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <8.74 ~ "First quantile",
                            poverty >=8.74 & poverty <11.59 ~ "Second quantile",
                            poverty >=11.59 & poverty <=19.28 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 TACNA
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_cr$povertypoor)*100,2)

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <9.48 ~ "First quantile",
                            poverty >=9.48 & poverty <10.96 ~ "Second quantile",
                            poverty >=10.96 & poverty <=15.18 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Tacna <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Tacna", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Tacna
```

## Poverty base TUMBES
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "TUMBES") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 TUMBES
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_mr$povertypoor)*100,2)

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <8.42 ~ "First quantile",
                            poverty >=8.42 & poverty <13.27 ~ "Second quantile",
                            poverty >=13.27 & poverty <=16.33 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 TUMBES
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_cr$povertypoor)*100,2)

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <8.09 ~ "First quantile",
                            poverty >=8.09 & poverty <9.80 ~ "Second quantile",
                            poverty >=9.80 & poverty <=15.88 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Tumbes <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Tumbes", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Tumbes
```

## Poverty base UCAYALI
```{r}
dep_poverty = 
  data_enaho %>%
  left_join(data_maternal_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  left_join(data_congenital_dist, by = c("year","NOMBDEP","NOMBPROV","NOMBDIST")) %>%
  select(poverty,year,NOMBDEP,NOMBPROV,NOMBDIST,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(year > "2014") %>%
  filter(NOMBDEP== "UCAYALI") %>%
  mutate(
    NOMBDIST = as.factor(NOMBDIST),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

#### Poverty objective 2 UCAYALI
```{r}
dep_poverty_mr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_mr$povertypoor)*100,2)

dep_poverty_mr = dep_poverty_mr %>%  
 mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <7.76 ~ "First quantile",
                            poverty >=7.76 & poverty <12.57 ~ "Second quantile",
                            poverty >=12.57 & poverty <=22.82 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_mat_mean=mean(rate_mat))

dep_poverty_mr %>% 
     DT::datatable()
``` 

```{r}
dep_poverty_mrg =
  ggplot(data = dep_poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_mrg

dep_poverty_mrg <- dep_poverty_mrg +
  ggtitle("Objective Two") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

Poverty objective 3 UCAYALI
```{r}
dep_poverty_cr = 
  dep_poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

round(summary(dep_poverty_cr$povertypoor)*100,2)

dep_poverty_cr = dep_poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <8.12 ~ "First quantile",
                            poverty >=8.12 & poverty <11.77 ~ "Second quantile",
                            poverty >=11.77 & poverty <=25.28 ~ "Third quantile",
                            TRUE ~ "Fourth quantile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(rate_con_mean=mean(rate_con))

dep_poverty_cr %>% 
     DT::datatable()
```

```{r}
dep_poverty_crg =
  ggplot(data = dep_poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

dep_poverty_crg 

dep_poverty_crg <- dep_poverty_crg +
  ggtitle("Objective Three") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r}
combined_plot <- dep_poverty_mrg + dep_poverty_crg + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

Ucayali <- combined_plot + 
  plot_annotation(
    title = "Objectives by Poverty at Ucayali", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"), 
      plot.margin = margin(5, 5, 5, 5)  
    )
  )

Ucayali
```

```{r}
National
Amazonas
Ancash
Arequipa
Ayacucho
Cajamarca
Callao
Cusco
Huancavelica
Huanuco
Ica
Junin
Lambayeque
Libertad
Lima
Loreto
MDD
Moquegua
Pasco
Piura
Puno
SM
Tacna
Tumbes
Ucayali
```

