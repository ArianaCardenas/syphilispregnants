---
title: "Determinantes_reg_natural"
output: html_document
date: "2024-07-19"
---

```{r}
library(sf)
library(purrr)
library(tidyverse)
library(ggplot2)
library(ggrepel)
library(readr)
library(survey)
library(gridExtra)
library(cowplot)
library(readxl)
library(wesanderson)
library(patchwork)
library(RSQLite)
```

```{r}
knitr::opts_chunk$set(
	echo = FALSE,
	cache = FALSE,
	dev = "png",
	dpi = 300
)
```

```{r}
data_enaho <- read_csv("Data_enaho/enaho2.csv")
data_ubigeo <- read_csv("Data_final/data_ubigeo_innovalab.csv")
departamentos <- read_sf("Límites - mapas/DEPARTAMENTOS_inei_geogpsperu_suyopomalia.shp")
#data_syphilis <- read_csv("Data_final/data_syphilis.csv")

data_enaho = rename(data_enaho, c("UBIGEO"="ubigeo"))

data_ubigeo = data_ubigeo %>%
  filter(year > 2014)

data_ubigeo = data_ubigeo [,c(8,10,12,14)]

data_ubigeo = distinct(data_ubigeo)

data_enaho <- data_enaho %>%
  left_join(data_ubigeo, by = c("UBIGEO")) %>%
  mutate(
    year = as.numeric(data_enaho$year),
    region_natural = case_when(NOMBDEP == "TUMBES"|NOMBDEP == "PIURA"|NOMBDEP == "LAMBAYEQUE"|NOMBDEP == "LA LIBERTAD"|NOMBDEP == "ANCASH"|NOMBDEP == "LIMA"|NOMBDEP == "CALLAO"|NOMBDEP == "ICA"|NOMBDEP == "AREQUIPA"|NOMBDEP == "MOQUEGUA"|NOMBDEP == "TACNA" ~ "COSTA",
                               NOMBDEP == "CAJAMARCA"|NOMBDEP == "HUANUCO"|NOMBDEP == "PASCO"|NOMBDEP == "JUNIN"|NOMBDEP == "HUANCAVELICA"|NOMBDEP == "AYACUCHO"|NOMBDEP == "APURIMAC"|NOMBDEP == "CUSCO"|NOMBDEP == "PUNO" ~ "SIERRA",
                               NOMBDEP == "AMAZONAS"|NOMBDEP == "SAN MARTIN"|NOMBDEP == "LORETO"|NOMBDEP == "UCAYALI"|NOMBDEP == "MADRE DE DIOS" ~ "SELVA")
  )

rm(data_syphilis,data_ubigeo)
```

Uploading MINSA data (maternal and congenital syphilis):
```{r, echo=FALSE}
maternal <- read_csv("Data_final/syphilis_maternal.csv")
newborn <- read_csv("Data_final/Nacidos_vivos_long.csv")
newborn_distrito <- read_excel("Data_final/Reniec_Nacimientos_Distritos.xlsx")

newborn_distrito = newborn_distrito %>% 
  mutate(across(c(NOMBDEP, NOMBPROV, NOMBDIST),
                ~ toupper(.x) %>%
                  stringi::stri_trans_general("Latin-ASCII")))

maternal = rename(
  maternal, c("NOMBDEP"="departamento","NOMBPROV"="provincia","NOMBDIST"="distrito"))
newborn = rename(
  newborn, c("NOMBDEP"="departamento","NOMBPROV"="provincia","year"="years"))

maternal_long <- pivot_longer(maternal, cols = c(4:11), 
                                names_to = "year", values_to = "maternal")

congenital <- read_csv("Data_final/syphilis_congenital.csv")

congenital <- congenital %>%
  select(!c(1))

congenital <- rename(
  congenital, c("NOMBDEP"="DEPARTAMENTO","NOMBPROV"="PROVINCIA","NOMBDIST"="DISTRITO"))

congenital_long <- pivot_longer(congenital, cols = c(4:12), 
                                names_to = "year", values_to = "congenital")

#Provincial
newborn_prov <- newborn %>%
  group_by(NOMBDEP, NOMBPROV, year) %>%
  summarise(newborntotal =sum(n, na.rm = TRUE)) %>%
  ungroup()

rm(maternal,congenital,newborn)
```

Maternal
```{r}
data_maternal_prov <- maternal_long %>%
  group_by(NOMBDEP, NOMBPROV, year) %>%
  filter( year > 2014) %>%
  summarise(maternal =sum(maternal, na.rm = TRUE)) %>%
  mutate(year=as.numeric(year))%>%
  ungroup()

#Calculating rates of maternal syphilis 
data_maternal_prov <- data_maternal_prov %>%
  left_join(newborn_prov, by = c("NOMBDEP","NOMBPROV","year")) %>%
  mutate(rate_mat = (maternal/newborntotal)*1000)
```

Congenital:
```{r}
congenital_long$year = as.numeric(congenital_long$year) 

#Provincial
congenital_long_prov <- congenital_long %>%
  group_by(NOMBDEP,NOMBPROV, year) %>%
  summarise(congenital = sum(congenital, na.rm = TRUE)) %>%
  unnest(congenital)

data_congenital_prov <- congenital_long_prov %>%
  left_join(newborn_prov, by = c("NOMBDEP","NOMBPROV","year")) %>%
  mutate(rate_con = (congenital/newborntotal)*1000) %>% 
  mutate_if(is.numeric, round, 2) %>%
  filter(rate_con < 100.0)

rm(congenital_long,congenital_long_dep,congenital_long_nac,newborn_nac,newborn_dep,data_ins_long,newborn_nac,newborn_dep, congenital_long_prov, departamentos, maternal_long, newborn_distrito, newborn_prov)
```

```{r}
selected_colors <- wes_palette("Zissou1", n = 5)[c(1, 3, 5)]
```

# Poverty National
```{r}
poverty = 
  data_enaho %>%
  left_join(data_maternal_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  left_join(data_congenital_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  select(poverty,year, region_natural, NOMBDEP,NOMBPROV,conglome,estrato,facpob07,rate_mat,rate_con,age) %>%
  filter(!is.na(poverty))%>%
  mutate(
    NOMBPROV = as.factor(NOMBPROV),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

## TERCILES

Poverty maternal (terciles)
```{r}
poverty_mr = 
  poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(poverty_mr$povertypoor, probs = c(1/3, 2/3))*100

poverty_mr = poverty_mr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <16.17 ~ "First tercile",
                            poverty >=16.17 & poverty <37.67 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
    summarize(
    rate_mat_mean = mean(rate_mat),
    ci_lower = ifelse(mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())<0,0,mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())),
    ci_upper = mean(rate_mat) + qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())
            )

summary(poverty_mr$rate_mat_mean)

poverty_mr %>% 
     DT::datatable()

National_pov_mat =
  ggplot(data = poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod, color = poverty_cod))+
  geom_line(size = 1.2)+
  xlab("Years") +
  ylab("Rate") +
  ylim(0,9) +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

National_pov_mat<- National_pov_mat +
  ggtitle("Poverty - Maternal") +
  theme(
    plot.title = element_text(size = 10), 
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(poverty_mr) 
```

Poverty congenital (terciles)
```{r}
poverty_cr = 
  poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(poverty_cr$povertypoor, probs = c(1/3, 2/3))*100

poverty_cr = poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <15.51 ~ "First tercile",
                            poverty >=15.51 & poverty <32.08 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(
    objective = 0.5,
    rate_con_mean = mean(rate_con),
    ci_lower = ifelse(mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())<0,0,mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())),
    ci_upper = mean(rate_con) + qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())
            )

summary(poverty_cr$rate_con_mean)

poverty_cr %>% 
     DT::datatable()

National_pov_con =
  ggplot(data = poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  geom_line(aes(y=objective),color = "black", linetype = "dashed", size=1.2) +
  xlab("Years") +
  ylab("Rate") +
  ylim(0,5) +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

National_pov_con  <- National_pov_con  +
  ggtitle("Poverty - Congenital") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(poverty_cr, poverty)
```


# Poverty Costa
```{r}
poverty = 
  data_enaho %>%
  left_join(data_maternal_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  left_join(data_congenital_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  select(poverty,year, region_natural, NOMBDEP,NOMBPROV,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(region_natural== "COSTA") %>%
  mutate(
    NOMBPROV = as.factor(NOMBPROV),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

## TERCILES

Poverty Costa maternal (terciles)
```{r}
poverty_mr = 
  poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(poverty_mr$povertypoor, probs = c(1/3, 2/3))*100

poverty_mr = poverty_mr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <10.56 ~ "First tercile",
                            poverty >=10.56 & poverty <24.25 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
    summarize(
    rate_mat_mean = mean(rate_mat),
    ci_lower = ifelse(mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())<0,0,mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())),
    ci_upper = mean(rate_mat) + qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())
            )

summary(poverty_mr$rate_mat_mean)

poverty_mr %>% 
     DT::datatable()

Costa_pov_mat =
  ggplot(data = poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  ylim(0,18) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Costa_pov_mat <- Costa_pov_mat +
  ggtitle("Maternal - Coast") +
  theme(
    plot.title = element_text(size = 10), 
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(poverty_mr)
```


Poverty Costa congenital (terciles)
```{r}
poverty_cr = 
  poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(poverty_cr$povertypoor, probs = c(1/3, 2/3))*100

poverty_cr = poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <11.08 ~ "First tercile",
                            poverty >=11.08 & poverty <22.66 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(
    objective = 0.5,
    rate_con_mean = mean(rate_con),
    ci_lower = ifelse(mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())<0,0,mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())),
    ci_upper = mean(rate_con) + qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())
            )

summary(poverty_cr$rate_con_mean)

poverty_cr %>% 
     DT::datatable()

Costa_pov_con =
  ggplot(data = poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  geom_line(aes(y=objective),color = "black", linetype = "dashed", size=1.2) +
  xlab("Years") +
  ylab("Rate") +
  ylim(0,8) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Costa_pov_con  <- Costa_pov_con  +
  ggtitle("Congenital - Coast") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(poverty_cr, poverty)
```

# Poverty Sierra
```{r}
poverty = 
  data_enaho %>%
  left_join(data_maternal_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  left_join(data_congenital_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  select(poverty,year, region_natural, NOMBDEP,NOMBPROV,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(region_natural== "SIERRA") %>%
  mutate(
    NOMBPROV = as.factor(NOMBPROV),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

## TERCILES

Poverty Sierra maternal (terciles)
```{r}
poverty_mr = 
  poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(poverty_mr$povertypoor, probs = c(1/3, 2/3))*100

poverty_mr = poverty_mr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <23.32 ~ "First tercile",
                            poverty >=23.32 & poverty <45.50 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
    summarize(
    rate_mat_mean = mean(rate_mat),
    ci_lower = ifelse(mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())<0,0,mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())),
    ci_upper = mean(rate_mat) + qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())
            )

summary(poverty_mr$rate_mat_mean)

poverty_mr %>% 
     DT::datatable()

Sierra_pov_mat =
  ggplot(data = poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  ylim(0,22) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Sierra_pov_mat <- Sierra_pov_mat +
  ggtitle("Maternal - Highlands") +
  theme(
    plot.title = element_text(size = 10), 
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1))+
  scale_color_manual(values = selected_colors)

rm(poverty_mr)
```

Poverty Sierra congenital (terciles)
```{r}
poverty_cr = 
  poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(poverty_cr$povertypoor, probs = c(1/3, 2/3))*100

poverty_cr = poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <22.02 ~ "First tercile",
                            poverty >=22.02 & poverty <40.32 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(
    objective=0.5,
    rate_con_mean = mean(rate_con),
    ci_lower = ifelse(mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())<0,0,mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())),
    ci_upper = mean(rate_con) + qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())
            )

summary(poverty_cr$rate_con_mean)

poverty_cr %>% 
     DT::datatable()

Sierra_pov_con =
  ggplot(data = poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  geom_line(aes(y=objective),color = "black", linetype = "dashed", size=1.2) +
  xlab("Years") +
  ylab("Rate") +
  ylim(0,8) +
  theme_bw() +
  theme(
   axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Sierra_pov_con  <- Sierra_pov_con  +
  ggtitle("Congenital - Highlands") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(poverty_cr, poverty)
```


# Poverty Selva
```{r}
poverty = 
  data_enaho %>%
  left_join(data_maternal_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  left_join(data_congenital_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  select(poverty,year, region_natural, NOMBDEP,NOMBPROV,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(poverty))%>%
  filter(region_natural== "SELVA") %>%
  mutate(
    NOMBPROV = as.factor(NOMBPROV),
    year = as.factor(year),
    poverty = as.factor(poverty)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

## TERCILES

Poverty Selva maternal (terciles)
```{r}
poverty_mr = 
  poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_mat , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(poverty_mr$povertypoor, probs = c(1/3, 2/3))*100

poverty_mr = poverty_mr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <18.50 ~ "First tercile",
                            poverty >=18.50 & poverty <35.86 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
    summarize(
    rate_mat_mean = mean(rate_mat),
    ci_lower = ifelse(mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())<0,0,mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())),
    ci_upper = mean(rate_mat) + qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())
            )

summary(poverty_mr$rate_mat_mean)

poverty_mr %>% 
     DT::datatable()

Selva_pov_mat =
  ggplot(data = poverty_mr,aes(x = year, y = rate_mat_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  xlab("Years") +
  ylab("Rate") +
  ylim(0,23) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Selva_pov_mat <- Selva_pov_mat +
  ggtitle("Maternal - Jungle") +
  theme(
    plot.title = element_text(size = 10), 
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1))+
  scale_color_manual(values = selected_colors)

rm(poverty_mr)
```

Poverty Selva congenital (terciles)
```{r}
poverty_cr = 
  poverty %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~poverty, by =~rate_con , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(poverty_cr$povertypoor, probs = c(1/3, 2/3))*100

poverty_cr = poverty_cr %>%  
  mutate(
    poverty = povertypoor*100,
    poverty_cod = case_when(poverty <18.34 ~ "First tercile",
                            poverty >=18.34 & poverty <32.19 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(poverty_cod))%>%
  group_by(year,poverty_cod)%>%
  summarize(
    objective = 0.5,
    rate_con_mean = mean(rate_con),
    ci_lower = ifelse(mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())<0,0,mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())),
    ci_upper = mean(rate_con) + qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())
            )

summary(poverty_cr$rate_con_mean)

poverty_cr %>% 
     DT::datatable()

Selva_pov_con =
  ggplot(data = poverty_cr,aes(x = year, y = rate_con_mean, group = poverty_cod))+
  geom_line(size = 1.2, aes(col = poverty_cod))+
  geom_line(aes(y=objective),color = "black", linetype = "dashed", size=1.2) +
  xlab("Years") +
  ylab("Rate") +
  ylim(0,8) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Selva_pov_con <- Selva_pov_con  +
  ggtitle("Congenital - Jungle") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(poverty_cr, poverty)
```

## Gráfico general
```{r, fig.height=6, fig.width=12}
combined_plot <- Costa_pov_con + Sierra_pov_con + Selva_pov_con + Costa_pov_mat + Sierra_pov_mat +  Selva_pov_mat + 
  plot_layout(ncol = 3, guides = 'collect') &  
  theme(legend.position = 'bottom')

Poverty_graph  <- combined_plot + 
  plot_annotation(
    title = "Poverty", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold")
    )
  )

Poverty_graph
ggsave("Poverty_reg.png", plot = Poverty_graph)

rm(Costa_pov_con, Sierra_pov_con, Selva_pov_con, Costa_pov_mat, Sierra_pov_mat, Selva_pov_mat)
```

# Lower Education National
```{r}
education = 
  data_enaho %>%
  left_join(data_maternal_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  left_join(data_congenital_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  select(education_level,year, region_natural, NOMBDEP,NOMBPROV,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(education_level))%>%
  mutate(
    NOMBPROV = as.factor(NOMBPROV),
    year = as.factor(year),
    education = as.factor(education_level)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

## TERCILES

Lower Education maternal (terciles)
```{r}
education_mr = 
  education %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~education, by =~rate_mat , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(education_mr$`educationless than secondary`, probs = c(1/3, 2/3))*100

education_mr = education_mr %>%  
  mutate(
    education = `educationless than secondary`*100,
    education_cod = case_when(education <18.45 ~ "First tercile",
                             education >=18.45 & education <40.55 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(education_cod))%>%
  group_by(year,education_cod)%>%
    summarize(
    rate_mat_mean = mean(rate_mat),
    ci_lower = ifelse(mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())<0,0,mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())),
    ci_upper = mean(rate_mat) + qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())
            )

summary(education_mr$rate_mat_mean)

education_mr %>% 
     DT::datatable()

National_edu_mat =
  ggplot(data = education_mr,aes(x = year, y = rate_mat_mean, group = education_cod))+
  geom_line(size = 1.2, aes(col = education_cod))+
  xlab("Years") +
  ylab("Rate") +
  ylim(0,9) +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

National_edu_mat <- National_edu_mat +
  ggtitle("Lower Education - Maternal") +
  theme(
    plot.title = element_text(size = 10), 
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1))+
  scale_color_manual(values = selected_colors)

rm(education_mr)
```

Lower education congenital (terciles)
```{r}
education_cr = 
  education %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~education, by =~rate_con , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(education_cr$`educationless than secondary`, probs = c(1/3, 2/3))*100

education_cr = education_cr %>%  
  mutate(
    education = `educationless than secondary`*100,
    education_cod = case_when(education <17.96 ~ "First tercile",
                             education >=17.96 & education <36.95 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(education_cod))%>%
  group_by(year,education_cod)%>%
    summarize(
      objective = 0.5,
    rate_con_mean = mean(rate_con),
    ci_lower = ifelse(mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())<0,0,mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())),
    ci_upper = mean(rate_con) + qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())
            )

summary(education_cr$rate_con_mean)

education_cr %>% 
     DT::datatable()

National_edu_con =
  ggplot(data = education_cr,aes(x = year, y = rate_con_mean, group = education_cod))+
  geom_line(size = 1.2, aes(col = education_cod))+
  geom_line(aes(y=objective),color = "black", linetype = "dashed", size=1.2) +
  xlab("Years") +
  ylab("Rate") +
  ylim(0,5) +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

National_edu_con  <- National_edu_con  +
  ggtitle("Lower Education - Congenital") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(education_cr, education)
```

# Lower Education Costa
```{r}
education = 
  data_enaho %>%
  left_join(data_maternal_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  left_join(data_congenital_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  select(education_level,year, region_natural, NOMBDEP,NOMBPROV,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(education_level))%>%
  filter(region_natural== "COSTA") %>%
  mutate(
    NOMBPROV = as.factor(NOMBPROV),
    year = as.factor(year),
    education = as.factor(education_level)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

## TERCILES

Costa Poverty maternal (terciles)
```{r}
education_mr = 
  education %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~education, by =~rate_mat , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(education_mr$`educationless than secondary`, probs = c(1/3, 2/3))*100

education_mr = education_mr %>%  
  mutate(
    education = `educationless than secondary`*100,
    education_cod = case_when(education <12.04 ~ "First tercile",
                             education >=12.04& education <25.63 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(education_cod))%>%
  group_by(year,education_cod)%>%
    summarize(
    rate_mat_mean = mean(rate_mat),
    ci_lower = ifelse(mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())<0,0,mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())),
    ci_upper = mean(rate_mat) + qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())
            )

summary(education_mr$rate_mat_mean)

education_mr %>% 
     DT::datatable()

Costa_edu_mat =
  ggplot(data = education_mr,aes(x = year, y = rate_mat_mean, group = education_cod))+
  geom_line(size = 1.2, aes(col = education_cod))+
  xlab("Years") +
  ylab("Rate") +
  ylim(0,12) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Costa_edu_mat  <- Costa_edu_mat  +
  ggtitle("Maternal - Coast") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(education_mr)
```


Costa Poverty congenital (terciles)
```{r}
education_cr = 
  education %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~education, by =~rate_con , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(education_cr$`educationless than secondary`, probs = c(1/3, 2/3))*100

education_cr = education_cr %>%  
  mutate(
    education = `educationless than secondary`*100,
    education_cod = case_when(education <11.92 ~ "First tercile",
                             education >=11.92 & education <22.37 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(education_cod))%>%
  group_by(year,education_cod)%>%
    summarize(
      objective = 0.5,
    rate_con_mean = mean(rate_con),
    ci_lower = ifelse(mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())<0,0,mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())),
    ci_upper = mean(rate_con) + qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())
            )

summary(education_cr$rate_con_mean)

education_cr %>% 
     DT::datatable()

Costa_edu_con =
  ggplot(data = education_cr,aes(x = year, y = rate_con_mean, group = education_cod))+
  geom_line(size = 1.2, aes(col = education_cod))+
  geom_line(aes(y=objective),color = "black", linetype = "dashed", size=1.2) +
  xlab("Years") +
  ylab("Rate") +
  ylim(0,7) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Costa_edu_con  <- Costa_edu_con  +
  ggtitle("Congenital - Coast") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(education_cr, education)
```


# Lower Education Sierra
```{r}
education = 
  data_enaho %>%
  left_join(data_maternal_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  left_join(data_congenital_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  select(education_level,year, region_natural, NOMBDEP,NOMBPROV,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(education_level))%>%
  filter(region_natural== "SIERRA") %>%
  mutate(
    NOMBPROV = as.factor(NOMBPROV),
    year = as.factor(year),
    education = as.factor(education_level)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

## TERCILES

Sierra Poverty objective 2 (terciles)
```{r}
education_mr = 
  education %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~education, by =~rate_mat , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(education_mr$`educationless than secondary`, probs = c(1/3, 2/3))*100

education_mr = education_mr %>%  
  mutate(
    education = `educationless than secondary`*100,
    education_cod = case_when(education <23.39 ~ "First tercile",
                             education >=23.39 & education <46.88 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(education_cod))%>%
  group_by(year,education_cod)%>%
    summarize(
    rate_mat_mean = mean(rate_mat),
    ci_lower = ifelse(mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())<0,0,mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())),
    ci_upper = mean(rate_mat) + qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())
            )

summary(education_mr$rate_mat_mean)

education_mr %>% 
     DT::datatable()

Sierra_edu_mat =
  ggplot(data = education_mr,aes(x = year, y = rate_mat_mean, group = education_cod))+
  geom_line(size = 1.2, aes(col = education_cod))+
  xlab("Years") +
  ylab("Rate") +
  ylim(0,12) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Sierra_edu_mat  <- Sierra_edu_mat  +
  ggtitle("Maternal - Highlands") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(education_mr)
```


Sierra Poverty objective 3 (terciles)
```{r}
education_cr = 
  education %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~education, by =~rate_con , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(education_cr$`educationless than secondary`, probs = c(1/3, 2/3))*100

education_cr = education_cr %>%  
  mutate(
    education = `educationless than secondary`*100,
    education_cod = case_when(education <26.04 ~ "First tercile",
                             education >=26.04 & education <46.55 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(education_cod))%>%
  group_by(year,education_cod)%>%
    summarize(
      objective = 0.5,
    rate_con_mean = mean(rate_con),
    ci_lower = ifelse(mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())<0,0,mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())),
    ci_upper = mean(rate_con) + qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())
            )

summary(education_cr$rate_con_mean)

education_cr %>% 
     DT::datatable()

Sierra_edu_con =
  ggplot(data = education_cr,aes(x = year, y = rate_con_mean, group = education_cod))+
  geom_line(size = 1.2, aes(col = education_cod))+
  geom_line(aes(y=objective),color = "black", linetype = "dashed", size=1.2) +
  xlab("Years") +
  ylab("Rate") +
  ylim(0,7) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Sierra_edu_con  <- Sierra_edu_con  +
  ggtitle("Congenital - Highlands") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(education_cr, education)
```


# Education Selva
```{r}
education = 
  data_enaho %>%
  left_join(data_maternal_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  left_join(data_congenital_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  select(education_level,year, region_natural, NOMBDEP,NOMBPROV,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(education_level))%>%
  filter(region_natural== "SELVA") %>%
  mutate(
    NOMBPROV = as.factor(NOMBPROV),
    year = as.factor(year),
    education = as.factor(education_level)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

## TERCILES

Education maternal (terciles)
```{r}
education_mr = 
  education %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~education, by =~rate_mat , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(education_mr$`educationless than secondary`, probs = c(1/3, 2/3))*100

education_mr = education_mr %>%  
  mutate(
    education = `educationless than secondary`*100,
    education_cod = case_when(education <25.67 ~ "First tercile",
                             education >=25.67 & education <48.89 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(education_cod))%>%
  group_by(year,education_cod)%>%
    summarize(
    rate_mat_mean = mean(rate_mat),
    ci_lower = ifelse(mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())<0,0,mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())),
    ci_upper = mean(rate_mat) + qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())
            )

summary(education_mr$rate_mat_mean)

education_mr %>% 
     DT::datatable()

Selva_edu_mat =
  ggplot(data = education_mr,aes(x = year, y = rate_mat_mean, group = education_cod))+
  geom_line(size = 1.2, aes(col = education_cod))+
  xlab("Years") +
  ylab("Rate") +
  ylim(0,12) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Selva_edu_mat  <- Selva_edu_mat  +
  ggtitle("Maternal - Jungle") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(education_mr)
```


Education objective 3 (terciles)
```{r}
education_cr = 
  education %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~education, by =~rate_con , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(education_cr$`educationless than secondary`, probs = c(1/3, 2/3))*100

education_cr = education_cr %>%  
  mutate(
    education = `educationless than secondary`*100,
    education_cod = case_when(education <26.52 ~ "First tercile",
                             education >=26.52 & education <45.89 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(education_cod))%>%
  group_by(year,education_cod)%>%
    summarize(
      objective = 0.5,
    rate_con_mean = mean(rate_con),
    ci_lower = ifelse(mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())<0,0,mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())),
    ci_upper = mean(rate_con) + qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())
            )

summary(education_cr$rate_con_mean)

education_cr %>% 
     DT::datatable()

Selva_edu_con =
  ggplot(data = education_cr,aes(x = year, y = rate_con_mean, group = education_cod))+
  geom_line(size = 1.2, aes(col = education_cod))+
  geom_line(aes(y=objective),color = "black", linetype = "dashed", size=1.2) +
  xlab("Years") +
  ylab("Rate") +
  ylim(0,7) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Selva_edu_con  <- Selva_edu_con  +
  ggtitle("Congenital - Jungle") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(education_cr, education)
```


## Gráfico general
```{r, fig.height=6, fig.width=12}
combined_plot <- Costa_edu_con + Sierra_edu_con + Selva_edu_con + Costa_edu_mat + Sierra_edu_mat + Selva_edu_mat +
  plot_layout(ncol = 3, guides = 'collect') &  
  theme(legend.position = 'bottom')

Education_graph  <- combined_plot + 
  plot_annotation(
    title = "Lower education", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold")
    )
  )

Education_graph
ggsave("Lower_education_reg.png", plot = Education_graph)

rm(Costa_edu_con, Sierra_edu_con, Selva_edu_con, Costa_edu_mat, Sierra_edu_mat, Selva_edu_mat)
```

# National Prenatal visit 

```{r}
no_pre = 
  data_enaho %>%
  left_join(data_maternal_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  left_join(data_congenital_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  select(prenatal_visit, control_iron, year, region_natural, NOMBDEP,NOMBPROV,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(prenatal_visit))%>%
  mutate(
    NOMBPROV = as.factor(NOMBPROV),
    year = as.factor(year),
    no_pre = as.factor(prenatal_visit)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

## TERCILES

Prenatal visit maternal (terciles)
```{r}
no_pre_mr = 
  no_pre %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~no_pre, by =~rate_mat , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(no_pre_mr$no_preno, probs = c(1/3, 2/3))*100

no_pre_mr = no_pre_mr %>%  
  mutate(
    no_pre = no_preno*100,
    no_pre_cod = case_when(no_pre <55.28 ~ "First tercile",
                            no_pre >=55.28 & no_pre <78.43 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(no_pre_cod))%>%
  group_by(year,no_pre_cod)%>%
    summarize(
    rate_mat_mean = mean(rate_mat),
    ci_lower = ifelse(mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())<0,0,mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())),
    ci_upper = mean(rate_mat) + qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())
            )

summary(no_pre_mr$rate_mat_mean)

no_pre_mr %>% 
     DT::datatable()

National_pre_mat =
  ggplot(data = no_pre_mr,aes(x = year, y = rate_mat_mean, group = no_pre_cod, color = no_pre_cod))+
  geom_line(size = 1.2)+
  xlab("Years") +
  ylab("Rate") +
  ylim(0,9) +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

National_pre_mat <- National_pre_mat +
  ggtitle("No prenatal visit - Maternal") +
  theme(
    plot.title = element_text(size = 10), 
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(no_pre_mr)
```



Prenatal visit 3 (terciles)
```{r}
no_pre_cr = 
  no_pre %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~no_pre, by =~rate_con , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(no_pre_cr$no_preno, probs = c(1/3, 2/3))*100

no_pre_cr = no_pre_cr %>%  
  mutate(
    no_pre = no_preno*100,
    no_pre_cod = case_when(no_pre <58.34 ~ "First tercile",
                            no_pre >=58.34 & no_pre <78.21 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(no_pre_cod))%>%
  group_by(year,no_pre_cod)%>%
  summarize(
    objective = 0.5,
    rate_con_mean = mean(rate_con),
    ci_lower = ifelse(mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())<0,0,mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())),
    ci_upper = mean(rate_con) + qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())
            )

summary(no_pre_cr$rate_con_mean)

no_pre_cr %>% 
     DT::datatable()

National_pre_con =
  ggplot(data = no_pre_cr,aes(x = year, y = rate_con_mean, group = no_pre_cod))+
  geom_line(size = 1.2, aes(col = no_pre_cod))+
  geom_line(aes(y=objective),color = "black", linetype = "dashed", size=1.2) +
  xlab("Years") +
  ylab("Rate") +
  ylim(0,5) +
  theme_bw() +
  theme(
    axis.title = element_text(face ="bold", size = 11),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

National_pre_con  <- National_pre_con  +
  ggtitle("No prenatal visit - Congenital") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(no_pre_cr, no_pre)
```

# Prenatal visit Costa
```{r}
no_pre= 
  data_enaho %>%
  left_join(data_maternal_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  left_join(data_congenital_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  select(prenatal_visit, control_iron, year, region_natural, NOMBDEP,NOMBPROV,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(prenatal_visit))%>%
  filter(region_natural== "COSTA") %>%
  mutate(
    NOMBPROV = as.factor(NOMBPROV),
    year = as.factor(year),
    no_pre = as.factor(prenatal_visit)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )

options(survey.lonely.psu="remove")
```

## TERCILES

Prenatal visit objective 2 (terciles)
```{r}
no_pre_mr = 
  no_pre %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~no_pre, by =~rate_mat , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(no_pre_mr$no_preno, probs = c(1/3, 2/3))*100

no_pre_mr = no_pre_mr %>%  
  mutate(
    no_pre = no_preno*100,
    no_pre_cod = case_when(no_pre <67.42 ~ "First tercile",
                             no_pre >=67.42 & no_pre <84.74 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(no_pre_cod))%>%
  group_by(year,no_pre_cod)%>%
    summarize(
    rate_mat_mean = mean(rate_mat),
    ci_lower = ifelse(mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())<0,0,mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())),
    ci_upper = mean(rate_mat) + qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())
            )

summary(no_pre_mr$rate_mat_mean)

no_pre_mr %>% 
     DT::datatable()

Costa_pre_mat =
  ggplot(data = no_pre_mr,aes(x = year, y = rate_mat_mean, group = no_pre_cod))+
  geom_line(size = 1.2, aes(col = no_pre_cod))+
  xlab("Years") +
  ylab("Rate") +
  ylim(0,15) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Costa_pre_mat  <- Costa_pre_mat  +
  ggtitle("Maternal - Coast") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(no_pre_mr)
```

Prenatal visit congenital (terciles)
```{r}
no_pre_cr = 
  no_pre %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~no_pre, by =~rate_con , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(no_pre_cr$no_preno, probs = c(1/3, 2/3))*100

no_pre_cr = no_pre_cr %>%  
  mutate(
    no_pre = no_preno*100,
    no_pre_cod = case_when(no_pre <68.92 ~ "First tercile",
                             no_pre >=68.92 & no_pre <83.38 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(no_pre_cod))%>%
  group_by(year,no_pre_cod)%>%
    summarize(
      objective = 0.5,
    rate_con_mean = mean(rate_con),
    ci_lower = ifelse(mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())<0,0,mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())),
    ci_upper = mean(rate_con) + qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())
            )

summary(no_pre_cr$rate_con_mean)

no_pre_cr %>% 
     DT::datatable()

Costa_pre_con =
  ggplot(data = no_pre_cr,aes(x = year, y = rate_con_mean, group = no_pre_cod))+
  geom_line(size = 1.2, aes(col = no_pre_cod))+
  geom_line(aes(y=objective),color = "black", linetype = "dashed", size=1.2) +
  xlab("Years") +
  ylab("Rate") +
  ylim(0,12) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Costa_pre_con  <- Costa_pre_con  +
  ggtitle("Congenital - Coast") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(no_pre_cr, no_pre)
```



# Prenatal visit Sierra
```{r}
no_pre= 
  data_enaho %>%
  left_join(data_maternal_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  left_join(data_congenital_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  select(prenatal_visit, control_iron, year, region_natural, NOMBDEP,NOMBPROV,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(prenatal_visit))%>%
  filter(region_natural== "SIERRA") %>%
  mutate(
    NOMBPROV = as.factor(NOMBPROV),
    year = as.factor(year),
    no_pre = as.factor(prenatal_visit)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )


options(survey.lonely.psu="remove")
```

## TERCILES

Sierra Prenatal visit objective 2 (terciles)
```{r}
no_pre_mr = 
  no_pre %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~no_pre, by =~rate_mat , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(no_pre_mr$no_preno, probs = c(1/3, 2/3))*100

no_pre_mr = no_pre_mr %>%  
  mutate(
    no_pre = no_preno*100,
    no_pre_cod = case_when(no_pre <54.06 ~ "First tercile",
                             no_pre >=54.06 & no_pre <75.00 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(no_pre_cod))%>%
  group_by(year,no_pre_cod)%>%
    summarize(
    rate_mat_mean = mean(rate_mat),
    ci_lower = ifelse(mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())<0,0,mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())),
    ci_upper = mean(rate_mat) + qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())
            )

summary(no_pre_mr$rate_mat_mean)

no_pre_mr %>% 
     DT::datatable()

Sierra_pre_mat =
  ggplot(data = no_pre_mr,aes(x = year, y = rate_mat_mean, group = no_pre_cod))+
  geom_line(size = 1.2, aes(col = no_pre_cod))+
  xlab("Years") +
  ylab("Rate") +
  ylim(0,15) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Sierra_pre_mat  <- Sierra_pre_mat  +
  ggtitle("Maternal - Highlands") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(no_pre_mr)
```


Sierra Prenatal visit objective 3 (terciles)
```{r}
no_pre_cr = 
  no_pre %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~no_pre, by =~rate_con , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(no_pre_cr$no_preno, probs = c(1/3, 2/3))*100

no_pre_cr = no_pre_cr %>%  
  mutate(
    no_pre = no_preno*100,
    no_pre_cod = case_when(no_pre <58.42 ~ "First tercile",
                             no_pre >=58.42 & no_pre <74.57 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(no_pre_cod))%>%
  group_by(year,no_pre_cod)%>%
    summarize(
      objective = 0.5,
    rate_con_mean = mean(rate_con),
    ci_lower = ifelse(mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())<0,0,mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())),
    ci_upper = mean(rate_con) + qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())
            )

summary(no_pre_cr$rate_con_mean)

no_pre_cr %>% 
     DT::datatable()

Sierra_pre_con =
  ggplot(data = no_pre_cr,aes(x = year, y = rate_con_mean, group = no_pre_cod))+
  geom_line(size = 1.2, aes(col = no_pre_cod))+
  geom_line(aes(y=objective),color = "black", linetype = "dashed", size=1.2) +
  xlab("Years") +
  ylab("Rate") +
  ylim(0,12) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Sierra_pre_con <- Sierra_pre_con  +
  ggtitle("Congenital - Highlands") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(no_pre_cr, no_pre)
```


# Selva Prenatal visit maternal
```{r}
no_pre= 
  data_enaho %>%
  left_join(data_maternal_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  left_join(data_congenital_prov, by = c("year","NOMBDEP","NOMBPROV")) %>%
  select(prenatal_visit, control_iron, year, region_natural, NOMBDEP,NOMBPROV,conglome,estrato,facpob07,rate_mat,rate_con) %>%
  filter(!is.na(prenatal_visit))%>%
  filter(region_natural== "SELVA") %>%
  mutate(
    NOMBPROV = as.factor(NOMBPROV),
    year = as.factor(year),
    no_pre = as.factor(prenatal_visit)
  ) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    df = map(.x=data,
             .f = ~svydesign(id = ~ conglome, strata = ~ estrato, weights = ~ facpob07, data = .x))
  )


options(survey.lonely.psu="remove")
```

## TERCILES

Selva Prenatal visit maternal (terciles)
```{r}
no_pre_mr = 
  no_pre %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~no_pre, by =~rate_mat , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(no_pre_mr$no_preno, probs = c(1/3, 2/3))*100

no_pre_mr = no_pre_mr %>%  
  mutate(
    no_pre = no_preno*100,
    no_pre_cod = case_when(no_pre <46.00 ~ "First tercile",
                             no_pre >=46.00 & no_pre <65.96 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(no_pre_cod))%>%
  group_by(year,no_pre_cod)%>%
    summarize(
    rate_mat_mean = mean(rate_mat),
    ci_lower = ifelse(mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())<0,0,mean(rate_mat) - qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())),
    ci_upper = mean(rate_mat) + qt(0.975, df = n() - 1) * sd(rate_mat) / sqrt(n())
            )

summary(no_pre_mr$rate_mat_mean)

no_pre_mr %>% 
     DT::datatable()

Selva_pre_mat =
  ggplot(data = no_pre_mr,aes(x = year, y = rate_mat_mean, group = no_pre_cod))+
  geom_line(size = 1.2, aes(col = no_pre_cod))+
  xlab("Years") +
  ylab("Rate") +
  ylim(0,15) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Selva_pre_mat  <- Selva_pre_mat  +
  ggtitle("Maternal - Jungle") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(no_pre_mr)
```

Selva Prenatal visit congenital (terciles)
```{r}
no_pre_cr = 
  no_pre %>%
  group_by(year) %>%
  mutate(
    wi = map(.x = df,
              .f = ~svyby(~no_pre, by =~rate_con , design = .x, FUN =svymean, deff=TRUE) %>% 
                as.data.frame())
  ) %>%
  unnest(wi) 
options(survey.lonely.psu="remove")

quantile(no_pre_cr$no_preno, probs = c(1/3, 2/3))*100

no_pre_cr = no_pre_cr %>%  
  mutate(
    no_pre = no_preno*100,
    no_pre_cod = case_when(no_pre <47.57 ~ "First tercile",
                             no_pre >=47.57 & no_pre <64.43 ~ "Second tercile",
                            TRUE ~ "Third tercile")) %>%
  filter(!is.na(no_pre_cod))%>%
  group_by(year,no_pre_cod)%>%
    summarize(
      objective = 0.5,
    rate_con_mean = mean(rate_con),
    ci_lower = ifelse(mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())<0,0,mean(rate_con) - qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())),
    ci_upper = mean(rate_con) + qt(0.975, df = n() - 1) * sd(rate_con) / sqrt(n())
            )

summary(no_pre_cr$rate_con_mean)

no_pre_cr %>% 
     DT::datatable()

Selva_pre_con =
  ggplot(data = no_pre_cr,aes(x = year, y = rate_con_mean, group = no_pre_cod))+
  geom_line(size = 1.2, aes(col = no_pre_cod))+
  geom_line(aes(y=objective),color = "black", linetype = "dashed", size=1.2) +
  xlab("Years") +
  ylab("Rate") +
  ylim(0,12) +
  theme_bw() +
  theme(
    axis.title =  element_blank(),
    legend.text = element_text(size = 8, face = "bold"),
    axis.text = element_text(face = "bold", family = "Arial"),
    axis.text.x = element_text( size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  )

Selva_pre_con  <- Selva_pre_con +
  ggtitle("Congenital - Jungle") +
  theme(
    plot.title = element_text(size = 10),  
    legend.position = "bottom", 
    legend.justification = "center") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_color_manual(values = selected_colors)

rm(no_pre_cr, no_pre)
```

## Gráfico general
```{r, fig.height=6, fig.width=12}
combined_plot <- Costa_pre_con + Sierra_pre_con + Selva_pre_con + Costa_pre_mat + Sierra_pre_mat +  Selva_pre_mat +
  plot_layout(ncol = 3, guides = 'collect') &  
  theme(legend.position = 'bottom')

Prenatal_graph  <- combined_plot + 
  plot_annotation(
    title = "No prenatal visit", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold")
    )
  )

Prenatal_graph
ggsave("No_prenatal_visit_reg.png", plot = Prenatal_graph)

rm(Costa_pre_con, Sierra_pre_con, Selva_pre_con, Costa_pre_mat, Sierra_pre_mat, Selva_pre_mat)
```

## Gráfico general
```{r, fig.height=6, fig.width=12}
combined_plot <- National_pov_con + National_edu_con + National_pre_con + National_pov_mat + National_edu_mat + National_pre_mat +
  plot_layout(ncol = 3, guides = 'collect') &  
  theme(legend.position = 'bottom')

National_graph  <- combined_plot + 
  plot_annotation(
    title = "National Graph", 
    theme = theme(
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold")
    )
  )

National_graph
ggsave("National.png", plot = National_graph)
```
